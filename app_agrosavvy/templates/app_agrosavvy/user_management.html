{% extends 'base.html' %}
{% load static %}
{% block header %}
{% endblock %}
{% block content %}

<div class="container mt-5">
    <div class="row">
        <!-- Main content area -->
        <div class="col-md-8">
            <!-- Active Users Section -->
            <h3 class="text-center mb-4">Registered Users</h3>
            <form method="get" action="{% url 'user_management' %}" class="mb-4">
                <div class="input-group">
                    <input type="text" name="registered_search" placeholder="Search registered users..." value="{{ registered_search_query }}" class="form-control">
                    <select name="registered_filter" class="form-select">
                        <option value="">All roles</option>
                        <option value="farmer" {% if registered_filter_type == 'farmer' %}selected{% endif %}>Farmer</option>
                        <option value="brgy_officer" {% if registered_filter_type == 'brgy_officer' %}selected{% endif %}>Barangay Officer</option>
                    </select>
                    <select name="registered_sort" class="form-select">
                        <option value="">Sort by</option>
                        <option value="username" {% if registered_sort_by == 'username' %}selected{% endif %}>Username</option>
                        <option value="email" {% if registered_sort_by == 'email' %}selected{% endif %}>Email</option>
                        <option value="firstname" {% if registered_sort_by == 'firstname' %}selected{% endif %}>First Name</option>
                        <option value="lastname" {% if registered_sort_by == 'lastname' %}selected{% endif %}>Last Name</option>
                    </select>
                    <button type="submit" class="btn btn-primary">Apply</button>
                </div>
            </form>
            <div class="table-responsive">
                {% if registered_users %}
                <table class="table table-borderless shadow-sm rounded">
                    <thead class="bg-dark text-white">
                        <tr>
                            <th>Official User ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Address</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for registered_user in registered_users_page_obj %}
                        <tr>
                            <td>{{ registered_user.official_user_id }}</td>
                            <td>{{ registered_user.firstname }} {{ registered_user.lastname }}</td>
                            <td>{{ registered_user.email }}</td>
                            <td>
                                {% if registered_user.roleuser.roleuser == "farmer" %}
                                Farmer
                                {% elif registered_user.roleuser.roleuser == "brgy_officer" %}
                                Barangay Officer
                                {% else %}
                                Unknown
                                {% endif %}
                            </td>
                            <td>{{ registered_user.useraddress }}</td>
                            <td>
                                {% if registered_user.active_status %}
                                <span class="badge bg-success">Active</span>
                                {% else %}
                                <span class="badge bg-danger">Deactivated</span>
                                {% endif %}
                            </td>
                            <td>
                                <!-- Button trigger modal -->
                                <div class="btn-group">
                                    {% if registered_user.active_status %}
                                    <form method="post" action="{% url 'admin_deactivate_account' registered_user.id %}" class="d-inline" id="deactivateForm">
                                        {% csrf_token %}
                                        <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmDeactivateModal">Deactivate</button>
                                    </form>
                                    {% else %}
                                    <form method="post" action="{% url 'admin_activate_account' registered_user.id %}" class="d-inline" id="activateForm">
                                        {% csrf_token %}
                                        <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#confirmActivateModal">Activate</button>
                                    </form>
                                    {% endif %}
                                </div>

                                <!-- Confirmation Modal for Deactivate -->
                                <div class="modal fade" id="confirmDeactivateModal" tabindex="-1" aria-labelledby="confirmDeactivateModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="confirmDeactivateModalLabel">Confirm Deactivation</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                Are you sure you want to deactivate this user?
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <button type="submit" form="deactivateForm" class="btn btn-outline-danger">Deactivate</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Confirmation Modal for Activate -->
                                <div class="modal fade" id="confirmActivateModal" tabindex="-1" aria-labelledby="confirmActivateModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="confirmActivateModalLabel">Confirm Activation</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                Are you sure you want to activate this user?
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <button type="submit" form="activateForm" class="btn btn-outline-success">Activate</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <!-- Pagination for Registered Users -->
                <nav aria-label="Page navigation" class="mt-3">
                    <ul class="pagination justify-content-center">
                        {% if registered_users_page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?registered_page={{ registered_users_page_obj.previous_page_number }}&registered_search={{ registered_search_query }}&registered_filter={{ registered_filter_type }}&registered_sort={{ registered_sort_by }}" aria-label="Previous">
                                &laquo;
                            </a>
                        </li>
                        {% endif %}
                        {% for num in registered_users_page_obj.paginator.page_range %}
                        <li class="page-item {% if registered_users_page_obj.number == num %}active{% endif %}">
                            <a class="page-link" href="?registered_page={{ num }}&registered_search={{ registered_search_query }}&registered_filter={{ registered_filter_type }}&registered_sort={{ registered_sort_by }}">{{ num }}</a>
                        </li>
                        {% endfor %}
                        {% if registered_users_page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?registered_page={{ registered_users_page_obj.next_page_number }}&registered_search={{ registered_search_query }}&registered_filter={{ registered_filter_type }}&registered_sort={{ registered_sort_by }}" aria-label="Next">
                                &raquo;
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% else %}
                <p class="text-muted text-center">No Registered Users</p>
                {% endif %}
            </div>

            <!-- Pending Users Section -->
            <h3 class="text-center mb-4 mt-5">Pending Users</h3>
            <form method="get" action="{% url 'user_management' %}" class="mb-4">
                <div class="input-group">
                    <input type="text" name="pending_search" placeholder="Search pending users..." value="{{ pending_search_query }}" class="form-control">
                    <select name="pending_filter" class="form-select">
                        <option value="">All roles</option>
                        <option value="farmer" {% if pending_filter_type == 'farmer' %}selected{% endif %}>Farmer</option>
                        <option value="brgy_officer" {% if pending_filter_type == 'brgy_officer' %}selected{% endif %}>Barangay Officer</option>
                    </select>
                    <select name="pending_sort" class="form-select">
                        <option value="">Sort by</option>
                        <option value="username" {% if pending_sort_by == 'username' %}selected{% endif %}>Username</option>
                        <option value="email" {% if pending_sort_by == 'email' %}selected{% endif %}>Email</option>
                        <option value="firstname" {% if pending_sort_by == 'firstname' %}selected{% endif %}>First Name</option>
                        <option value="lastname" {% if pending_sort_by == 'lastname' %}selected{% endif %}>Last Name</option>
                        <option value="request_date" {% if pending_sort_by == 'request_date' %}selected{% endif %}>Request Date</option>
                    </select>
                    <button type="submit" class="btn btn-primary">Apply</button>
                </div>
            </form>
            <div class="table-responsive">
                {% if pending_users %}
                <table class="table table-borderless shadow-sm rounded">
                    <thead class="bg-dark text-white">
                        <tr>
                            <th>Official User ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Address</th>
                            <th>Request Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pending_user in pending_users_page_obj %}
                        <tr>
                            <td>{{ pending_user.official_user_id }}</td>
                            <td>{{ pending_user.firstname }} {{ pending_user.lastname }}</td>
                            <td>{{ pending_user.email }}</td>
                            <td>
                                {% if pending_user.roleuser.roleuser == "farmer" %}
                                Farmer
                                {% elif pending_user.roleuser.roleuser == "brgy_officer" %}
                                Barangay Officer
                                {% else %}
                                Unknown
                                {% endif %}
                            </td>
                            <td>{{ pending_user.useraddress }}</td>
                            <td>{{ pending_user.request_date }}</td>
                            <td>
                              <!-- Button trigger modal -->
                                <div class="btn-group">
                                    <form method="post" action="{% url 'admin_approve_user' pending_user.id %}" class="d-inline" id="approveForm">
                                        {% csrf_token %}
                                        <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#confirmApproveModal">Approve</button>
                                    </form>
                                    <form method="post" action="{% url 'admin_disapprove_user' pending_user.id %}" class="d-inline" id="disapproveForm">
                                        {% csrf_token %}
                                        <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmDisapproveModal">Disapprove</button>
                                    </form>
                                </div>

                                <!-- Confirmation Modal for Approve -->
                                <div class="modal fade" id="confirmApproveModal" tabindex="-1" aria-labelledby="confirmApproveModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered"> <!-- Center the modal -->
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="confirmApproveModalLabel">Confirm Approval</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                Are you sure you want to approve this user?
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <button type="submit" form="approveForm" class="btn btn-outline-success">Approve</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Confirmation Modal for Disapprove -->
                                <div class="modal fade" id="confirmDisapproveModal" tabindex="-1" aria-labelledby="confirmDisapproveModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered"> <!-- Center the modal -->
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="confirmDisapproveModalLabel">Confirm Disapproval</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                Are you sure you want to disapprove this user?
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <button type="submit" form="disapproveForm" class="btn btn-outline-danger">Disapprove</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <!-- Pagination for Pending Users -->
                <nav aria-label="Page navigation" class="mt-3">
                    <ul class="pagination justify-content-center">
                        {% if pending_users_page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?pending_page={{ pending_users_page_obj.previous_page_number }}&pending_search={{ pending_search_query }}&pending_filter={{ pending_filter_type }}&pending_sort={{ pending_sort_by }}" aria-label="Previous">
                                &laquo;
                            </a>
                        </li>
                        {% endif %}
                        {% for num in pending_users_page_obj.paginator.page_range %}
                        <li class="page-item {% if pending_users_page_obj.number == num %}active{% endif %}">
                            <a class="page-link" href="?pending_page={{ num }}&pending_search={{ pending_search_query }}&pending_filter={{ pending_filter_type }}&pending_sort={{ pending_sort_by }}">{{ num }}</a>
                        </li>
                        {% endfor %}
                        {% if pending_users_page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?pending_page={{ pending_users_page_obj.next_page_number }}&pending_search={{ pending_search_query }}&pending_filter={{ pending_filter_type }}&pending_sort={{ pending_sort_by }}" aria-label="Next">
                                &raquo;
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% else %}
                <p class="text-muted text-center">No Pending Users</p>
                {% endif %}
            </div>
        </div>

        <!-- Sidebar with Recent Activities -->
        <div class="col-md-4">
            <!-- User Log -->
            <div class="rounded p-3 bg-light shadow-sm mb-4">
                <h4><strong>User Log</strong></h4>
                <div>
                    {% for event in login_events|slice:":5" %}
                    <div class="mb-3">
                        <span>
                            {% if event.user_id == null %}
                            <strong>unknown user</strong>
                            {% else %}
                            <strong>@ {{ event.user.username }}</strong>
                            {% endif %}
                            {% if event.login_type == 0 %}logged in{% elif event.login_type == 1 %}logged out{% elif event.login_type == 2 %}failed login{% else %}error{% endif %}
                            {{ event.datetime|timesince }} ago
                        </span>
                        <p class="small">IP: {{ event.remote_ip }}</p>
                    </div>
                    {% empty %}
                    <p>No login events found.</p>
                    {% endfor %}
                </div>
            </div>

            <!-- CRUD Log -->
            <div class="rounded p-3 bg-light shadow-sm">
                <h4><strong>CRUD Log</strong></h4>
                <div>
                    {% for event in crud_events|slice:":5" %}
                    <div class="mb-3">
                        <span>
                            {% if event.user_id == null %}
                            <strong>unknown user</strong>
                            {% else %}
                            <strong>@ {{ event.user.username }}</strong>
                            {% endif %}
                            {% if event.event_type == 1 %}
                            added
                            {% elif event.event_type == 2 %}
                            {% if event.changed_fields %}
                            {% if 'is_deleted' in event.changed_fields %}
                            {% if event.changed_fields.is_deleted.0 == "False" %}
                            updated
                            (Changed fields: {{ event.changed_fields }})
                            {% else %}
                            deleted
                            {% endif %}
                            {% else %}
                            updated
                            {% endif %}
                            {% else %}
                            updated
                            {% endif %}
                            {% elif event.event_type == 3 %}
                            deleted
                            {% else %}
                            error
                            {% endif %}
                            {{ event.object_repr }}
                            ,{{ event.datetime|timesince }} ago
                        </span>
                    </div>  
                    {% empty %}
                    <p>No CRUD events found.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
