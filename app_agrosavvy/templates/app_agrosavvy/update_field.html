{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Form section -->
        <div class="col-md-6 ml-1">
            <div class="card shadow p-4">
                <h1 class="mb-4">Update Field</h1>
                <form id="fieldForm" method="POST">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <div class="form-group">
                        <button type="button" id="geocodeButton" class="btn btn-primary">Show on Map</button>
                        <button type="submit" class="btn btn-success">Update</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- Map section -->
        <div class="col-md-6">
            <div class="card shadow">
                <div id="map" style="height: 680px;"></div>
            </div>
        </div>
    </div>
</div>
<script>
    // Function to handle form submission
        //transferred to server side for simplicity








    
    // Function to initialize the map and handle map-related operations
    function initializeMap() {
        // Set up Mapbox access token
        mapboxgl.accessToken = 'pk.eyJ1IjoiZnJhbnpnYWJpamFuIiwiYSI6ImNsdmV3dTljbTBlbzkya3BlY2Rwa28xczgifQ.z1HHDbS-prv9A3gwQJK43A';

        // Initialize the map
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [123.876705, 10.308258], // Default center coordinates
            zoom: 10 // Default zoom level
        });

        // Initialize marker with draggable functionality
        var marker = new mapboxgl.Marker({ draggable: true })
            .setLngLat([ 20.9842, 14.5995 ])        //default marker just to work
            .addTo(map);

        // Function to run when dragging of the marker ends
        function onDragEnd() {
            var lngLat = marker.getLngLat();
            document.getElementById('id_latitude').value = lngLat.lat;
            document.getElementById('id_longitude').value = lngLat.lng;
            getAddress(lngLat.lng, lngLat.lat); // Fetch and update address fields
        }

        // Attach the onDragEnd function to the marker's dragend event
        marker.on('dragend', onDragEnd);

        // Function to get the address from coordinates using Mapbox Geocoding API
        function getAddress(lng, lat) {
            var url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${mapboxgl.accessToken}`;
            $.get(url, function (data) {
                if (data.features.length > 0) {
                    var place = data.features[0];
                    var context = place.context;
                    var barangay = '';
                    var city_municipality = '';
                    var country = '';

                    // Extracting the address components from the API response
                    place.context.forEach(function (item) {
                        if (item.id.includes('neighborhood') || item.id.includes('locality')) {
                            barangay = item.text;
                        } else if (item.id.includes('place')) {
                            city_municipality = item.text;
                        } else if (item.id.includes('country')) {
                            country = item.text;
                        }
                    });

                    // Update the form inputs with the extracted address components
                    document.getElementById('id_barangay').value = barangay;
                    document.getElementById('id_city_municipality').value = city_municipality;
                    document.getElementById('id_country').value = country;
                }
            });
        }

        // Event handler for the geocode button click
        $('#geocodeButton').click(function () {
            var address = $('#id_barangay').val() + ', ' + $('#id_city_municipality').val() + ', ' + $('#id_country').val();
            var url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${mapboxgl.accessToken}`;
            $.get(url, function (data) {
                if (data.features.length > 0) {
                    var lngLat = data.features[0].center;
                    marker.setLngLat(lngLat); // Move marker to the geocoded coordinates
                    map.flyTo({ center: lngLat }); // Fly to the new location on the map
                    document.getElementById('id_latitude').value = lngLat[1]; // Update latitude input
                    document.getElementById('id_longitude').value = lngLat[0]; // Update longitude input
                } else {
                    alert('Address not found');
                }
            });
        });
    }

    // Call the functions on document ready
    $(document).ready(function() {
        initializeMap(); // Initialize map
    });
</script>

{% endblock %}
