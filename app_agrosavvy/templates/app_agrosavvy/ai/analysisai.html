{% extends 'base.html' %}
{% block header %}
{% endblock %}
{% block content %}
<style>
    /* Centered Tabs Styles */
    .nav-tabs {
        margin-top: 20px;
        justify-content: center;
        border-bottom: 2px solid #e0e0e0;
    }

    .nav-link {
        padding: 10px 20px;
        color: #333;
        font-weight: 500;
        transition: color 0.3s, background-color 0.3s;
        border: none;
    }

    .nav-link.active {
        color: #007bff;
        border-bottom: 3px solid #007bff;
        background-color: transparent;
        font-weight: bold;
    }

    .nav-link:not(.active):hover {
        color: #0056b3;
        background-color: #f8f9fa;
        border-radius: 5px;
    }

    #spinnerContainer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        display: none;
    }

    /* Sidebar Styling */
    .sidebar-history {
        background-color: #ffffff;
        position: fixed;
        top: 80px;
        left: 100px;
        width: 270px;
        max-height: 500px;
        overflow-y: auto;
        border-right: 1px solid #ccc;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
        margin-bottom: 200px;
        box-shadow: 2px 0px 10px rgba(0, 0, 0, 0.1);
    }

    .history-item {
        padding: 10px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: background-color 0.3s;
        border-radius: 5px;
    }

    .history-item:hover {
        background-color: #f0f0f0;
    }

    .history-item.active {
        background-color: #e9ecef;
        font-weight: bold;
    }

    .history-item h4 {
        margin: 0;
        font-size: 14px;
    }

    /* Main Content Area */
    .main-content {
        margin-left: 300px; /* Adjust margin for sidebar */
        padding: 20px;
    }

    /* Field Analyzer Form */
    .form-container {
        padding: 20px;
        background-color: #fff;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
    }

    .form-result {
        margin-top: 20px;
    }

    /* Hide Analysis Output Initially */
    .analysis-output {
        display: none;
        margin-top: 10px;
    }

    .history-item.active .analysis-output {
        display: block;
    }

    /* History Item Styling */
    .history-item img {
        max-width: 100px;
        margin-right: 10px;
    }

    .history-item .analysis-output {
        margin-top: 10px;
    }

    /* Scrollable Sidebar */
    .sidebar-history ul {
        list-style: none;
        padding: 0;
    }

    .sidebar-history li {
        margin-bottom: 20px;
    }
</style>

<div id="spinnerContainer">
    <div class="spinner-grow text-success spinner-grow-sm" role="status">
        <span class="sr-only">Loading...</span>
    </div>
    <div class="spinner-grow text-success spinner-grow-sm mx-2" role="status">
        <span class="sr-only">Loading...</span>
    </div>
    <div class="spinner-grow text-success spinner-grow-sm" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>

<div class="container">
    <div class="d-flex justify-content-center mb-4">
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a href="{% url 'chat' %}" class="nav-link" data-tab="analyze">Chat</a>
            </li>
            <li class="nav-item">
                <a href="{% url 'image_analysis' %}" class="nav-link active" data-tab="analyze">Analyze</a>
            </li>
        </ul>
    </div>

    <!-- Sidebar for History -->
    <div class="sidebar-history ms-4">
        <div class="message-label mt-4"><h6>Analysis History</h6></div>
        <ul id="analyzed_image-history">
            {% if history %}
            {% for item in history %}
            <li class="history-item mb-3" id="analysis-{{ item.pk }}" onclick="toggleHistoryContent('{{ item.pk }}')">
                <h4>{{ item.created_at|date:"F j, Y, g:i a" }}</h4>
                <img src="{{ item.image.url }}" alt="Analyzed Image" class="img-fluid mb-2">
                <div class="analysis-output" id="output-{{ item.pk }}">
                    {{ item.analysis_output|safe }}
                </div>
            </li>
            {% endfor %}
            {% else %}
            <p>No analysis history available.</p>
            {% endif %}
        </ul>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <div class="form-container">
            <h2 class="h4">Image Analyzer</h2>
            <form method="POST" id="analyzeForm" enctype="multipart/form-data">
                {% csrf_token %}
                {{ form.as_p }}
                <button id="analyzeCropBtn" class="btn btn-success w-100">Analyze</button>
            </form>
            <div id="analyzeResult" class="mt-2"></div>
        </div>

        <!-- Displaying Analysis Output -->
        {% if analysis_output %}
        <div class="recommendations mt-4">
            <h3>Output:</h3>
            <div class="recommendation-content">
                <p>{{ analysis_output|safe }}</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    document.getElementById('analyzeForm').onsubmit = function () {
        document.getElementById('spinnerContainer').style.display = 'flex';
    };

    // Function to toggle visibility of history content in sidebar
    function toggleHistoryContent(id) {
        const allItems = document.querySelectorAll('.history-item');
        const selectedItem = document.getElementById('analysis-' + id);
        const selectedOutput = document.getElementById('output-' + id);

        // Reset all items
        allItems.forEach(item => item.classList.remove('active'));
        document.querySelectorAll('.analysis-output').forEach(output => output.style.display = 'none');

        // Activate clicked item and show content in main content
        selectedItem.classList.add('active');
        selectedOutput.style.display = 'block';
    }
</script>

{% endblock %}
