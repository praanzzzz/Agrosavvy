{% extends 'base.html' %}
{% block header %}
{% endblock %}
{% block content %}
<style>
    /* Centered Tabs Styles */
    .nav-tabs {
        margin-top: 20px;
        justify-content: center;
        border-bottom: 2px solid #e0e0e0;
    }

    .nav-link {
        padding: 10px 20px;
        color: #333;
        font-weight: 500;
        transition: color 0.3s, background-color 0.3s;
        border: none;
    }

    .nav-link.active {
        color: #007bff;
        border-bottom: 3px solid #007bff;
        background-color: transparent;
        font-weight: bold;
    }

    .nav-link:not(.active):hover {
        color: #0056b3;
        background-color: #f8f9fa;
        border-radius: 5px;
    }

    #spinnerContainer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        display: none;
    }
</style>




<div id="spinnerContainer">
    <div class="spinner-grow text-success spinner-grow-sm" role="status">
        <span class="sr-only">Loading...</span>
    </div>
    <div class="spinner-grow text-success spinner-grow-sm mx-2" role="status">
        <span class="sr-only">Loading...</span>
    </div>
    <div class="spinner-grow text-success spinner-grow-sm" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>




<div class="container">
    <div class="d-flex justify-content-center mb-4">
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a href="{% url 'chat' %}" class="nav-link" data-tab="analyze">Chat</a>
            </li>
            <li class="nav-item">
                <a href="{% url 'image_analysis' %}" class="nav-link active" data-tab="analyze">Analyze</a>
            </li>
        </ul>
    </div>

    <div id="analyzeTab" class="tab-content active">
        <div class="card p-4">
            <h2 class="h4">Field Analyzer</h2>
            <form method="POST" id="analyzeForm" enctype="multipart/form-data">
                {% csrf_token %}
                {{ form.as_p }}
                <button id="analyzeCropBtn" class="btn btn-success w-100">Analyze Field</button>
            </form>
            <div id="analyzeResult" class="mt-2"></div>
        </div>
        {% if analysis_output %}
        <div class="recommendations mt-4">
            <h3>Output:</h3>
            <div class="recommendation-content">
                <p>{{ analysis_output|safe }}</p>
            </div>
        </div>
        {% endif %}

        <!-- Add this section for the history -->
        <div class="history mt-4">
            <h3>Analysis History</h3>
            {% if history %}
            {% for item in history %}
            <div class="history-item mb-3" id="analysis-{{ item.pk }}">
                <h4>Analysis from {{ item.created_at|date:"F j, Y, g:i a" }}</h4>
                <img src="{{ item.image.url }}" alt="Analyzed Image" class="img-fluid mb-2" style="max-width: 200px;">
                <div class="analysis-output">
                    {{ item.analysis_output|safe }}
                </div>

                <!-- Delete button (trigger the modal) -->
                <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal"
                    data-bs-target="#confirmDeleteModal{{ item.pk }}">
                    Delete
                </button>

                <!-- Confirmation Modal -->
                <div class="modal fade" id="confirmDeleteModal{{ item.pk }}" tabindex="-1"
                    aria-labelledby="confirmDeleteModalLabel{{ item.pk }}" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="confirmDeleteModalLabel{{ item.pk }}">Confirm Deletion</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                Are you sure you want to delete this field?
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <form action="{% url 'delete_image_analysis' item.pk %}" method="post"
                                    class="d-inline-block">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-danger">Delete</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p>No analysis history available.</p>
            {% endif %}
        </div>
    </div>
</div>
<script>
    document.getElementById('analyzeForm').onsubmit = function () {
      document.getElementById('spinnerContainer').style.display = 'flex';
    };
  </script>
  


{% endblock %}