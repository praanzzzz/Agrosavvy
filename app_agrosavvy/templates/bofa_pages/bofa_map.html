{% extends 'bofa_base.html' %}
{% block content %}

<style>
    body, html {
        height: 100%;
        margin: 0;
        width: auto;
        overflow: hidden;
    }

    #map {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }

    #crop-filter {
        position: fixed;
        top: 150px;
        left: 1200px;
        z-index: 1;
        background-color: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }
</style>

<div id="crop-filter">
    <label for="crop-select">Filter by Crop:</label>
    <select id="crop-select">
        <option value="all">All</option>
        {% for crop in crops %}
        <option value="{{ crop.crop_type }}">{{ crop.crop_type }}</option>
        {% endfor %}
    </select>
</div>

<div id="map"></div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiZnJhbnpnYWJpamFuIiwiYSI6ImNsdmV3dTljbTBlbzkya3BlY2Rwa28xczgifQ.z1HHDbS-prv9A3gwQJK43A';

    // Initialize Mapbox map
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/satellite-streets-v11',
        center: [123.80833, 10.34629],
        zoom: 11
    });

    // Parse JSON data passed from server-side
    var fields = JSON.parse('{{ fields_json|escapejs }}');
    var markers = [];

    // Function to add markers to the map
    function addMarkers(fields) {
        fields.forEach(function(field) {
            var marker = new mapboxgl.Marker()
                .setLngLat([field.longitude, field.latitude])
                .setPopup(new mapboxgl.Popup({ offset: 25 }).setText(`${field.name}, Acres: ${field.acres}`))
                .addTo(map);
            markers.push(marker);
        });
    }

    // Initial load of markers
    addMarkers(fields);

    // Filter markers based on selected crop
    document.getElementById('crop-select').addEventListener('change', function() {
        var selectedCrop = this.value;
        
        // Remove all existing markers
        markers.forEach(function(marker) {
            marker.remove();
        });
        markers = [];

        // Add markers based on the selected crop
        if (selectedCrop === 'all') {
            addMarkers(fields);
        } else {
            var filteredFields = fields.filter(function(field) {
                return field.crop === selectedCrop;
            });
            addMarkers(filteredFields);
        }
    });
</script>

{% endblock %}
